name: n8n Automation Server

on:
  workflow_dispatch:

env:
  CONTAINER_NAME: n8n-runner
  N8N_PORT: 5678

jobs:
  start-n8n:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 0. Set Image Name (Force Lowercase)
      - name: Set Image Name
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${OWNER}/n8n-workspace:latest" >> $GITHUB_ENV

      # 1. ğŸ§¹ Bersih-Bersih Storage
      - name: ğŸ§¹ Free Disk Space
        run: |
          echo "ğŸ’¾ Storage Sebelum Diet:"
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          sudo docker image prune --all --force
          
          echo "ğŸ’¾ Storage Setelah Diet:"
          df -h

      # 2. Login GHCR
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Load Save / New Game
      - name: ğŸ® Load atau New Game
        run: |
          if docker manifest inspect $IMAGE_NAME > /dev/null 2>&1; then
            echo "âœ… SAVE DATA DITEMUKAN! Loading n8n workspace..."
            docker pull $IMAGE_NAME
            
            # --- LOAD GAME ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p $N8N_PORT:5678 \
              --hostname="n8n-server" \
              -e TZ="Asia/Jakarta" \
              -e N8N_SECURE_COOKIE=false \
              $IMAGE_NAME
              
          else
            echo "ğŸ†• SAVE DATA KOSONG. Setup n8n baru..."
            
            # --- NEW GAME ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p $N8N_PORT:5678 \
              --hostname="n8n-server" \
              -e TZ="Asia/Jakarta" \
              -e N8N_BASIC_AUTH_ACTIVE=true \
              -e N8N_BASIC_AUTH_USER=${{ secrets.N8N_USER }} \
              -e N8N_BASIC_AUTH_PASSWORD=${{ secrets.N8N_PASS }} \
              -e N8N_SECURE_COOKIE=false \
              -e N8N_HOST=0.0.0.0 \
              -e WEBHOOK_URL=https://${{ secrets.N8N_DOMAIN }} \
              -e N8N_EDITOR_BASE_URL=https://${{ secrets.N8N_DOMAIN }} \
              docker.n8n.io/n8nio/n8n:latest
            
            echo "â³ Waiting n8n to start..."
            sleep 15
            
            # Check if running
            docker logs $CONTAINER_NAME
          fi
          
          echo "ğŸ“¦ Container status:"
          docker ps

      # 4. Install & Start Cloudflare Tunnel
      - name: ğŸš‡ Start Cloudflare Tunnel
        run: |
          echo "â¬‡ï¸ Downloading Cloudflared..."
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          echo "ğŸš‡ Starting Tunnel..."
          nohup cloudflared tunnel run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }} > /dev/null 2>&1 &
          
          sleep 5
          echo "âœ… Tunnel connected!"

      # 5. Sesi Aktif (5 Jam)
      - name: â³ Sesi Aktif (5 Jam)
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ğŸš€ n8n READY!"
          echo "=========================================="
          echo ""
          echo "ğŸŒ Access: https://${{ secrets.N8N_DOMAIN }}"
          echo "ğŸ‘¤ User: (check secrets N8N_USER)"
          echo "ğŸ”‘ Pass: (check secrets N8N_PASS)"
          echo ""
          echo "â° Session: 5 jam"
          echo "ğŸ’¾ Auto-save saat selesai"
          echo "=========================================="
          
          # Keep alive + monitoring
          for i in $(seq 1 300); do
            echo "â±ï¸ Uptime: $((i * 60)) detik | Container: $(docker ps --filter name=$CONTAINER_NAME --format '{{.Status}}')"
            sleep 60
          done

      # 6. Auto Save
      - name: ğŸ’¾ Save Progress
        if: always()
        run: |
          echo "ğŸ’¾ Menyimpan n8n workspace..."
          
          # Commit dengan label biar ke-link ke repo
          docker commit \
            --change='LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}' \
            --change='LABEL org.opencontainers.image.description=n8n Automation Workspace' \
            $CONTAINER_NAME $IMAGE_NAME
          
          docker push $IMAGE_NAME
          echo "âœ… Progress tersimpan ke GHCR!"
