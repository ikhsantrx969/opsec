name: Android Dev Abadi

on:
  workflow_dispatch:

env:
  CONTAINER_NAME: vscode-runner

jobs:
  start-coding:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 0. Set Image Name (Force Lowercase)
      - name: Set Image Name
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${OWNER}/android-dev-space:latest" >> $GITHUB_ENV

      # 1. ğŸ§¹ BERSIH-BERSIH STORAGE (WAJIB DI AWAL)
      - name: ğŸ§¹ Free Disk Space (Maximize Storage)
        run: |
          echo "ğŸ’¾ Storage Sebelum Diet:"
          df -h
          
          # Hapus sampah bawaan GitHub runner
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          sudo docker image prune --all --force
          
          echo "ğŸ’¾ Storage Setelah Diet:"
          df -h

      # 2. Login GHCR
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Load Save / New Game
      - name: Load Save Data
        run: |
          if docker manifest inspect $IMAGE_NAME > /dev/null 2>&1; then
            echo "âœ… SAVE DATA DITEMUKAN! Loading container..."
            docker pull $IMAGE_NAME
            
            # --- LOAD GAME ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              --privileged \
              --device /dev/kvm \
              --shm-size="2g" \
              --hostname="NetSec-God-Box" \
              -e TZ="Asia/Jakarta" \
              -v /var/run/docker.sock:/var/run/docker.sock \
              $IMAGE_NAME
              
          else
            echo "ğŸ†• SAVE DATA KOSONG. New Game..."
            
            # --- NEW GAME ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              --privileged \
              --device /dev/kvm \
              --shm-size="2g" \
              --hostname="NetSec-God-Box" \
              -e TZ="Asia/Jakarta" \
              -e PASSWORD="${{ secrets.VSCODE_PASS }}" \
              -v /var/run/docker.sock:/var/run/docker.sock \
              codercom/code-server:latest
            
            # Install tools dasar
            echo "Installing basic tools..."
            docker exec $CONTAINER_NAME sudo apt-get update
            docker exec $CONTAINER_NAME sudo apt-get install -y git nodejs npm curl docker.io
            # Fix permission socket di dalem container
            docker exec $CONTAINER_NAME sudo chmod 666 /var/run/docker.sock
          fi

      # 4. Install & Start Cloudflare Tunnel (Manual Binary)
      - name: Install & Start Tunnel
        run: |
          echo "â¬‡ï¸ Downloading Cloudflared..."
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          echo "ğŸš‡ Starting Tunnel..."
          # Tunnel HTTP buat VS Code
          cloudflared tunnel run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }} --url http://localhost:8080 > tunnel.log 2>&1 &

      # 5. Sesi Aktif (5 Jam)
      - name: â³ Sesi Aktif (5 Jam)
        continue-on-error: true
        run: |
          echo "ğŸš€ LINK AKSES: https://vscode.domain-lu.com"
          sleep 18000 # 5 Jam

      # 6. Auto Save (Jalan Terus)
      - name: ğŸ’¾ SAVE GAME (Commit & Push)
        if: always()
        run: |
          echo "ğŸ’¾ Menyimpan progress..."
          docker commit $CONTAINER_NAME $IMAGE_NAME
          docker push $IMAGE_NAME
          echo "âœ… Progress tersimpan!"          fi

      # 3. Cloudflare Tunnel (FIXED)
      - name: Start Tunnel
        run: |
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          # âœ… FIXED: Pakai token aja (URL udah diconfig di dashboard)
          nohup cloudflared tunnel run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }} > /dev/null 2>&1 &
          
          sleep 5
          echo "âœ… Tunnel started!"

      # 4. Sesi Aktif
      - name: â³ Sesi Aktif (5 Jam)
        continue-on-error: true
        run: |
          echo "ğŸš€ LINK: https://cspace.ikhsantrx.web.id"
          sleep 18000

      # 5. Save dengan Label (Auto-link ke repo)
      - name: ğŸ’¾ Save Progress
        if: always()
        run: |
          docker commit \
            --change='LABEL org.opencontainers.image.source=https://github.com/${{ github.repository }}' \
            $CONTAINER_NAME $IMAGE_NAME
          
          docker push $IMAGE_NAME
          echo "âœ… Saved to GHCR (Public = Unlimited Storage)!"
