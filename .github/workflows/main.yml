name: n8n Automation Server

on:
  workflow_dispatch:

env:
  CONTAINER_NAME: n8n-runner
  N8N_PORT: 5678
  # Semua Env n8n kita taruh di sini biar konsisten
  TZ: Asia/Jakarta
  N8N_SECURE_COOKIE: 'false'
  N8N_BASIC_AUTH_ACTIVE: 'true'
  N8N_BASIC_AUTH_USER: ${{ secrets.N8N_USER }}
  N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_PASS }}
  N8N_HOST: 0.0.0.0
  WEBHOOK_URL: https://${{ secrets.N8N_DOMAIN }}
  N8N_EDITOR_BASE_URL: https://${{ secrets.N8N_DOMAIN }}
  # Volume untuk data n8n
  N8N_DATA_VOLUME: n8n_data

jobs:
  start-n8n:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 0. Set Image Name (Force Lowercase)
      - name: set image name
        run: |
          owner=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${owner}/n8n-workspace:latest" >> $github_env

      # 1. üßπ bersih-bersih storage
      - name: free disk space
        run: |
          echo "üíæ storage sebelum diet:"
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          sudo docker image prune --all --force
          
          echo "üíæ storage setelah diet:"
          df -h

      # 2. login ghcr
      - name: login ghcr
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. load save / new game
      - name: load atau new game
        run: |
          # buat volume biar data persisten
          docker volume create $N8N_DATA_VOLUME
          
          if docker manifest inspect $IMAGE_NAME > /dev/null 2>&1; then
            echo "‚úÖ save data ditemukan! loading n8n workspace..."
            docker pull $IMAGE_NAME
            
            # --- load game ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p $N8N_PORT:5678 \
              --hostname="n8n-server" \
              --env-file <(env | grep -e "^TZ=" -e "^N8N_") \
              --mount type=volume,source=$N8N_DATA_VOLUME,target=/home/node/.n8n \
              $IMAGE_NAME
              
          else
            echo "üÜï save data kosong. setup n8n baru..."
            
            # --- new game ---
            docker run -d \
              --name $CONTAINER_NAME \
              -p $N8N_PORT:5678 \
              --hostname="n8n-server" \
              --env-file <(env | grep -e "^TZ=" -e "^N8N_") \
              --mount type=volume,source=$N8N_DATA_VOLUME,target=/home/node/.n8n \
              docker.n8n.io/n8nio/n8n:latest
            
            echo "‚è≥ waiting n8n to start..."
            sleep 15
            
            # check if running
            docker logs $CONTAINER_NAME
          fi
          
          echo "üì¶ container status:"
          docker ps

      # 4. install & start cloudflare tunnel
      - name: start cloudflare tunnel
        run: |
          echo "‚¨áÔ∏è downloading cloudflared..."
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

          echo "üöá starting tunnel..."
          nohup cloudflared tunnel run --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }} > /dev/null 2>&1 &
          
          sleep 5
          echo "‚úÖ tunnel connected!"

      # 5. sesi aktif (5 jam)
      - name: sesi aktif (5 jam)
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "üöÄ n8n ready!"
          echo "=========================================="
          echo ""
          echo "üåê access: https://${{ secrets.N8N_DOMAIN }}"
          echo "üë§ user: (check secrets n8n_user)"
          echo "üîë pass: (check secrets n8n_pass)"
          echo ""
          echo "‚è∞ session: 5 jam"
          echo "üíæ auto-save saat selesai"
          echo "=========================================="
          
          # keep alive + monitoring
          for i in $(seq 1 300); do
            echo "‚è±Ô∏è uptime: $((i * 60)) detik | container: $(docker ps --filter name=$CONTAINER_NAME --format '{{.Status}}')"
            sleep 60
          done

      # 6. auto save
      - name: save progress
        if: always()
        run: |
          echo "üíæ menyimpan n8n workspace..."
          
          # commit the container data volume to the image
          docker commit \
            --change='label org.opencontainers.image.source=https://github.com/${{ github.repository }}' \
            --change='label org.opencontainers.image.description=n8n automation workspace' \
            --change='volume /home/node/.n8n' \
            $CONTAINER_NAME $IMAGE_NAME
          
          docker push $IMAGE_NAME
          
          # clean up volume after saving
          docker volume rm $N8N_DATA_VOLUME
          echo "‚úÖ progress tersimpan ke ghcr dan volume dibersihkan!"
